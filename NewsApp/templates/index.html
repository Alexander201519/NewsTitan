<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsTitan</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e14; --card: #151921; --text: #ffffff; --subtext: #8892b0;
            --accent: #00e5ff; --secondary: #ff2a6d; --border: #2d343f;
        }
        body.light-mode {
            --bg: #f4f7fa; --card: #ffffff; --text: #1a202c; --subtext: #4a5568;
            --accent: #3182ce; --secondary: #e53e3e; --border: #e2e8f0;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        #progress-bar { width: 0%; height: 4px; background: var(--accent); position: fixed; top: 0; z-index: 1000; transition: 0.4s; }
        #auto-timer-bar { width: 0%; height: 4px; background: #f1c40f; position: fixed; top: 4px; z-index: 1000; }

        .navbar { display: flex; gap: 8px; padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); justify-content: center; flex-wrap: wrap; align-items: center; }
        .nav-btn { background: transparent; border: 1px solid var(--border); color: var(--subtext); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .nav-btn.active { color: var(--accent); border-color: var(--accent); }
        
        /* RESTORED: Filter Bar */
        .filter-bar { display: flex; gap: 10px; justify-content: center; padding: 15px; background: rgba(0,0,0,0.1); border-bottom: 1px solid var(--border); }
        input, select { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; font-family: inherit; }

        .container { max-width: 700px; margin: 30px auto; padding: 0 20px; }
        .news-card { background: var(--card); border-radius: 20px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.2); border: 1px solid var(--border); }
        #news-img { width: 100%; height: 350px; object-fit: cover; }
        .content { padding: 30px; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 5px; font-size: 0.7rem; font-weight: 800; background: var(--accent); color: #000; margin-bottom: 10px; cursor: pointer; }

        /* Sidebar */
        #sidebar { position: fixed; right: -350px; top: 0; width: 320px; height: 100%; background: var(--card); transition: 0.4s; padding: 25px; box-shadow: -10px 0 30px rgba(0,0,0,0.3); z-index: 999; overflow-y: auto; border-left: 1px solid var(--border); }
        #sidebar.open { right: 0; }
        .fav-item { background: var(--bg); padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); position: relative; }
        .delete-one { position: absolute; top: 10px; right: 10px; background: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer; padding: 2px 8px; font-size: 10px; }

        .history-item { font-size: 0.8rem; padding: 8px 0; border-bottom: 1px solid var(--border); cursor: pointer; color: var(--subtext); }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; flex: 1; transition: 0.2s; text-transform: uppercase; font-size: 0.8rem; }
        .btn-next { background: var(--accent); color: #000; width: 100%; margin-top: 15px; font-size: 1.1rem; }
        
        .auto-active { background: #f1c40f !important; color: black !important; border-color: #f1c40f !important; }
    </style>
</head>
<body id="body">

    <div id="progress-bar"></div>
    <div id="auto-timer-bar"></div>

    <div class="navbar">
        <div id="today-date" style="color:var(--accent); font-weight:800; font-size:0.8rem; margin-right:10px"></div>
        <button class="nav-btn active" onclick="setCategory('General', this)">General</button>
        <button class="nav-btn" onclick="setCategory('Politics', this)">Politics</button>
        <button class="nav-btn" onclick="setCategory('Tech', this)">Tech</button>
        <button class="nav-btn" onclick="setCategory('Weird', this)">Weird</button>
        <button class="nav-btn" onclick="setCategory('Entertainment', this)">Entertain</button>
        <button class="nav-btn" onclick="setCategory('Gaming', this)">Gaming</button>
        <button class="nav-btn" onclick="setCategory('LongReads', this)">LongReads</button>
        <button class="nav-btn" id="auto-btn" onclick="toggleAuto()">üöÄ AUTO</button>
        <button class="nav-btn" onclick="toggleSidebar()" style="background:var(--secondary); color:white; border:none">‚≠ê LIST</button>
        <button class="nav-btn" onclick="toggleTheme()">üåì</button>
    </div>

    <div class="filter-bar">
        <input type="text" id="search-input" placeholder="Search keywords..." onkeypress="if(event.key==='Enter') loadNews()">
        <select id="source-select" onchange="loadNews()">
            <option value="">All Sources</option>
            <option value="bbc.com">BBC News</option>
            <option value="reuters.com">Reuters</option>
            <option value="ign.com">IGN</option>
            <option value="theverge.com">The Verge</option>
            <option value="cnn.com">CNN</option>
        </select>
        <button class="btn" style="background:var(--accent); color:black; flex:none; width:50px" onclick="loadNews()">üîç</button>
    </div>

    <div id="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h2>Favorites</h2>
            <button onclick="clearAllFavs()" style="background:var(--secondary); color:white; border:none; padding:5px; border-radius:4px; font-size:0.6rem; cursor:pointer">CLEAR ALL</button>
        </div>
        <div id="fav-list"></div>
    </div>

    <div class="container">
        <div class="news-card">
            <img id="news-img" src="">
            <div class="content">
                <span id="source-badge" class="badge" onclick="visitSubreddit()">FETCHING...</span>
                <h2 id="news-title" style="margin: 0 0 15px 0;">Loading fresh news...</h2>
                
                <div class="btn-group">
                    <button class="btn" style="background:#3498db; color:white" onclick="read()">READ</button>
                    <button class="btn" style="background:var(--secondary); color:white" onclick="save()">‚ù§ SAVE</button>
                    <button class="btn" style="background:#8e44ad; color:white" onclick="share()">üìã SHARE</button>
                </div>
                <button class="btn btn-next" onclick="loadNews()">NEXT STORY ‚ûî</button>
            </div>
        </div>

        <div style="margin-top:20px">
            <h4 style="margin-bottom:10px; opacity:0.5">Recent History</h4>
            <div id="history-list"></div>
        </div>
    </div>

    <script>
        let currentCat = "General";
        let currentUrl = "";
        let autoInterval = null;
        let historyArr = [];
        let subName = "";

        function displayDate() {
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            document.getElementById('today-date').innerText = new Date().toLocaleDateString('en-US', options).toUpperCase();
        }

        async function loadNews() {
            if(currentUrl && document.getElementById('news-title').innerText !== "Loading fresh news...") {
                addToHistory(document.getElementById('news-title').innerText, currentUrl);
            }

            const search = document.getElementById('search-input').value;
            const source = document.getElementById('source-select').value;
            const bar = document.getElementById('progress-bar');
            bar.style.width = "40%";
            
            const response = await fetch(`/get_news?category=${currentCat}&search=${search}&source=${source}`);
            const data = await response.json();
            
            bar.style.width = "100%";
            document.getElementById('news-title').innerText = data.title || data.error;
            document.getElementById('source-badge').innerText = data.source ? data.source.toUpperCase() : "SEARCH";
            subName = data.source || "";
            currentUrl = data.url;

            const img = document.getElementById('news-img');
            if(data.image) { img.src = data.image; img.style.display = 'block'; }
            else { img.style.display = 'none'; }
            
            setTimeout(() => { bar.style.width = "0%"; }, 400);
            if(autoInterval) resetAutoTimer();
        }

        function resetAutoTimer() {
            const timerBar = document.getElementById('auto-timer-bar');
            timerBar.style.transition = 'none'; timerBar.style.width = '0%';
            setTimeout(() => { timerBar.style.transition = 'width 8s linear'; timerBar.style.width = '100%'; }, 50);
        }

        function toggleAuto() {
            const btn = document.getElementById('auto-btn');
            const timerBar = document.getElementById('auto-timer-bar');
            if (autoInterval) {
                clearInterval(autoInterval); autoInterval = null;
                btn.innerText = "üöÄ AUTO"; btn.classList.remove('auto-active'); timerBar.style.width = '0%';
            } else {
                btn.innerText = "üõë STOP"; btn.classList.add('auto-active');
                loadNews(); autoInterval = setInterval(loadNews, 8000);
            }
        }

        function addToHistory(title, url) {
            historyArr.unshift({title, url});
            if(historyArr.length > 5) historyArr.pop();
            renderHistory();
        }
        function renderHistory() {
            document.getElementById('history-list').innerHTML = historyArr.map(h => `
                <div class="history-item" onclick="window.open('${h.url}', '_blank')">‚Ü∫ ${h.title}</div>
            `).join('');
        }

        function save() {
            let favs = JSON.parse(localStorage.getItem('titan_favs') || "[]");
            favs.push({title: document.getElementById('news-title').innerText, url: currentUrl});
            localStorage.setItem('titan_favs', JSON.stringify(favs));
            renderFavs();
        }

        function deleteOne(index) {
            let favs = JSON.parse(localStorage.getItem('titan_favs') || "[]");
            favs.splice(index, 1);
            localStorage.setItem('titan_favs', JSON.stringify(favs));
            renderFavs();
        }

        function clearAllFavs() { if(confirm("Clear all?")) { localStorage.removeItem('titan_favs'); renderFavs(); } }

        function renderFavs() {
            const list = document.getElementById('fav-list');
            const favs = JSON.parse(localStorage.getItem('titan_favs') || "[]");
            list.innerHTML = favs.map((f, i) => `
                <div class="fav-item">
                    <button class="delete-one" onclick="deleteOne(${i})">X</button>
                    <strong>${f.title}</strong>
                    <a href="${f.url}" target="_blank" style="color:var(--accent); display:block; font-size:0.7rem; margin-top:5px">Open ‚ûî</a>
                </div>
            `).join('');
        }

        function setCategory(cat, btn) {
            currentCat = cat;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('search-input').value = ""; // Clear search on cat change
            loadNews();
        }

        function toggleTheme() { document.getElementById('body').classList.toggle('light-mode'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); renderFavs(); }
        function share() { navigator.clipboard.writeText(currentUrl); alert("Copied!"); }
        function read() { window.open(currentUrl, '_blank'); }
        function visitSubreddit() { if(subName) window.open(`https://reddit.com/${subName}`, '_blank'); }
        
        displayDate();
        loadNews();
    </script>
</body>
</html>